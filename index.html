<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compras de Katherine y Henrry</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .bought{ text-decoration: line-through; opacity:.5 }
        .category-header {
            background: linear-gradient(to right, #f3f4f6, #ffffff);
            border-left: 4px solid #2563eb;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 pb-44">

<h1 class="text-2xl font-bold text-center mb-4">üè† Compras de Katherine y Henrry</h1>

<button onclick="installApp()" class="bg-green-600 text-white w-full p-3 rounded-xl mb-3 shadow-md active:scale-95 transition-transform">
    üì≤ Guardar como App
</button>

<div class="bg-white p-4 rounded-xl mb-4 shadow-sm border border-gray-200">
    <h2 class="font-bold mb-2 text-gray-700">‚ûï Agregar nuevo art√≠culo</h2>
    <input id="newName" placeholder="Nombre del art√≠culo" class="border p-2 w-full mb-2 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
    <input id="newPrice" type="number" placeholder="Precio" class="border p-2 w-full mb-2 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
    
    <select id="categorySelect" class="border p-2 w-full mb-2 rounded-lg bg-white" onchange="toggleNewCategoryInput()"></select>
    
    <input id="newCategoryInput" placeholder="Escribe nueva categor√≠a" class="border p-2 w-full mb-2 rounded-lg hidden">
    
    <button onclick="addItem()" class="bg-blue-600 text-white w-full p-2 rounded-lg font-bold hover:bg-blue-700 transition-colors">
        Agregar a la lista
    </button>
</div>

<div id="content"></div>

<div class="fixed bottom-0 left-0 right-0 bg-white p-4 border-t shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-50">
    <div class="flex justify-between text-sm mb-1">
        <span class="text-gray-600">Total General:</span>
        <span class="font-bold text-blue-600">RD$ <span id="totalSpan">0</span></span>
    </div>
    <div class="flex justify-between text-sm mb-1">
        <span class="text-gray-600">Ya comprado:</span>
        <span class="font-bold text-green-600">RD$ <span id="boughtSpan">0</span></span>
    </div>
    <div class="flex justify-between text-lg border-t pt-1">
        <span class="font-bold">Falta por comprar:</span>
        <span class="font-bold text-red-600">RD$ <span id="remainSpan">0</span></span>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBZOqWiu3SfwlldceYZ6wt9jDXriAE8uJ0",
        authDomain: "mudanza-katherine-henry.firebaseapp.com",
        databaseURL: "https://mudanza-katherine-henry-default-rtdb.firebaseio.com",
        projectId: "mudanza-katherine-henry",
        storageBucket: "mudanza-katherine-henry.firebasestorage.app",
        messagingSenderId: "637697134729",
        appId: "1:637697134729:web:beb82cb28b6701ce5c7658"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const dbRef = ref(db, 'compras');

    // DATOS ORIGINALES COMPLETOS
    const dataInit = {
        "üîå Electrodom√©sticos":[
            ["üß∫ Lavadora",68000,true],["üßä Nevera",52000,true],["üî• Estufa",62000,true],
            ["ü•§ Licuadora",6000,false],["‚ùÑÔ∏è Aire",35800,true],["üì∫ TV",40000,false],
            ["üç≤ Microondas",7800,true],["üçû Tostadora",6795,true],
            ["üçü Freidora",5000,false],["üõ¢Ô∏è Extractor",10000,false],["üßÉ Jugo",5000,false]
        ],
        "ü™ë Muebles":[
            ["üõãÔ∏è Mueble",70000,false],["üçΩÔ∏è Comedor",70000,false],
            ["üóÑÔ∏è Gavetero",20000,false],["üì¶ Credenza",10000,false],
            ["üõèÔ∏è Mesitas",12000,false]
        ],
        "‚ö° Energ√≠a y gas":[
            ["üîã Inversor",34000,false],["‚õΩ Tanques gas",10000,false]
        ],
        "üè† Hogar":[
            ["üåÄ Abanico",3500,false],["üëî Plancha",3000,false],["ü™ü Cortinas",5000,false],
            ["üõèÔ∏è S√°banas",5000,false],["üõå Almohadas",5000,false],["üñºÔ∏è Cuadros",5000,false],
            ["ü™û Espejos",5000,false],["ü™Ñ Palo cortina",5000,false],
            ["ü™ë Sillas",1500,false],["üç≥ Ollas",10000,false],
            ["üçΩÔ∏è Platos",10000,false],["üèãÔ∏è Gym",30000,false]
        ],
        "üçΩÔ∏è Utensilios":[
            ["üçΩÔ∏è Platos",1100,false],["ü•£ Hondos",660,false],["ü•Ñ Cucharas",300,false],
            ["üç¥ Tenedores",300,false],["üî™ Cuchillos",500,false],["ü•õ Vasos",695,false],
            ["üç∑ Copas",515,false],["‚òï Tazas",500,false],["üç≥ Sartenes",2000,false],
            ["üî™ Carne",1000,true],["ü™µ Tabla",1000,true],["üì¶ Porta",850,true],
            ["‚òï Greca",865,true]
        ]
    };

    // EL ORDEN QUE T√ö QUIERES
    const ORDEN_PRIORIDAD = [
        "üîå Electrodom√©sticos",
        "ü™ë Muebles",
        "‚ö° Energ√≠a y gas",
        "üè† Hogar",
        "üçΩÔ∏è Utensilios"
    ];

    let data = {};

    onValue(dbRef, (snapshot) => {
        const val = snapshot.val();
        if (val) {
            data = val;
        } else {
            data = dataInit;
            set(dbRef, dataInit);
        }
        render();
    });

    window.addItem = () => {
        let name = document.getElementById("newName").value.trim();
        let price = Number(document.getElementById("newPrice").value);
        let cat = document.getElementById("categorySelect").value;
        if(cat === "__new__") cat = document.getElementById("newCategoryInput").value.trim();
        if(!name || !price || !cat) return alert("Llena todos los campos");
        if(!data[cat]) data[cat] = [];
        data[cat].push([name, price, false]);
        set(dbRef, data);
        document.getElementById("newName").value = "";
        document.getElementById("newPrice").value = "";
    };

    window.toggle = (cat, i) => { data[cat][i][2] = !data[cat][i][2]; set(dbRef, data); };
    window.updateName = (cat, i, v) => { data[cat][i][0] = v; set(dbRef, data); };
    window.updatePrice = (cat, i, v) => { data[cat][i][1] = Number(v); set(dbRef, data); };
    window.delItem = (cat, i) => { if(confirm("¬øBorrar art√≠culo?")){ data[cat].splice(i,1); if(!data[cat].length) delete data[cat]; set(dbRef, data); }};
    window.renameCategory = (old) => { 
        let n = prompt("Nuevo nombre:", old); 
        if(n && n !== old) { data[n] = data[old]; delete data[old]; set(dbRef, data); }
    };
    window.deleteCategory = (c) => { if(confirm("¬øBorrar categor√≠a completa?")){ delete data[c]; set(dbRef, data); }};
    window.toggleNewCategoryInput = () => { document.getElementById("newCategoryInput").classList.toggle("hidden", document.getElementById("categorySelect").value !== "__new__"); };

    function render() {
        let cont = document.getElementById("content"), t=0, b=0, r=0;
        cont.innerHTML = "";

        const categoriasOrdenadas = Object.keys(data).sort((a, b) => {
            let idxA = ORDEN_PRIORIDAD.indexOf(a);
            let idxB = ORDEN_PRIORIDAD.indexOf(b);
            if (idxA === -1) idxA = 999;
            if (idxB === -1) idxB = 999;
            return idxA - idxB;
        });

        categoriasOrdenadas.forEach(cat => {
            let div = document.createElement("div");
            div.className = "category-header flex justify-between mt-6 p-2 rounded-r-lg font-bold text-gray-800 shadow-sm";
            div.innerHTML = `<span>${cat}</span>
                <div class="flex gap-3 text-xs">
                    <button onclick="renameCategory('${cat}')" class="text-blue-500">Editar</button>
                    <button onclick="deleteCategory('${cat}')" class="text-red-500">Borrar</button>
                </div>`;
            cont.appendChild(div);

            data[cat].forEach((it, i) => {
                t+=it[1]; it[2]? b+=it[1] : r+=it[1];
                let item = document.createElement("div");
                item.className = "bg-white p-3 rounded-xl flex items-center gap-2 mt-2 shadow-sm border border-gray-100";
                item.innerHTML = `
                    <input type="checkbox" ${it[2]?'checked':''} onclick="toggle('${cat}',${i})" class="w-6 h-6 rounded">
                    <input value="${it[0]}" onchange="updateName('${cat}',${i},this.value)" class="flex-grow ${it[2]?'bought text-gray-400':'text-gray-700'}">
                    <div class="flex items-center text-xs text-gray-400">RD$
                        <input type="number" value="${it[1]}" onchange="updatePrice('${cat}',${i},this.value)" class="w-20 ml-1 font-bold text-black border-b border-gray-200 text-right">
                    </div>
                    <button onclick="delItem('${cat}',${i})" class="text-red-300 text-2xl ml-1">√ó</button>`;
                cont.appendChild(item);
            });
        });

        document.getElementById("totalSpan").innerText = t.toLocaleString();
        document.getElementById("boughtSpan").innerText = b.toLocaleString();
        document.getElementById("remainSpan").innerText = r.toLocaleString();
        
        const sel = document.getElementById("categorySelect");
        const curr = sel.value; sel.innerHTML = "";
        categoriasOrdenadas.forEach(c => sel.add(new Option(c, c)));
        sel.add(new Option("‚ûï Nueva categor√≠a...", "__new__"));
        if(curr) sel.value = curr;
    }
</script>

<script>
    function installApp() { 
        alert("Para instalar:\n1. Toca 'Compartir'.\n2. 'Agregar a inicio'."); 
    }
</script>
</body>
</html>
